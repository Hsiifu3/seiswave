# SeisWave v2 - 需求规格

## 概述

将 SeisWave 从基础地震信号处理库升级为完整的地震动选波与人工波生成工具，融合 Panchatantra/EQSignal（C++ 算法骨架）和用户 MATLAB 选波程序（GB 50011 规范谱 + PEER 选波流程），最终打包为 Windows 桌面应用程序。

## 用户故事

### US-1: 规范反应谱生成

作为结构工程师，我希望根据设防参数（烈度、场地类别、阻尼比）自动生成规范设计反应谱，以便作为选波和人工波生成的目标谱。

**验收标准**：
- [ ] AC-1.1: WHEN 用户指定烈度（6/7/7.5/8/8.5/9度）、场地类别（I~IV）和阻尼比 THE SYSTEM SHALL 自动计算特征周期 Tg 和地震影响系数最大值 α_max，生成 GB 50011 抗震规范反应谱
- [ ] AC-1.2: WHEN 用户选择隔震模式 THE SYSTEM SHALL 生成 GB 50011 隔震规范反应谱（三段式：直线上升段 + 水平段 + 曲线下降段，周期范围 0~6s）
- [ ] AC-1.3: WHEN 用户需要扩展规范 THE SYSTEM SHALL 预留规范谱扩展接口（v2 仅实现 GB 50011）
- [ ] AC-1.4: WHEN 用户指定自定义阻尼比（非 5%）THE SYSTEM SHALL 正确计算阻尼调整系数 η₁、η₂ 和衰减指数 γ
- [ ] AC-1.5: WHEN 规范谱生成完成 THE SYSTEM SHALL 在界面上绘制谱曲线，并支持导出为 CSV/图片

### US-2: 地震动文件读取

作为结构工程师，我希望批量导入 PEER NGA 数据库下载的地震动文件，以便进行后续选波分析。

**验收标准**：
- [ ] AC-2.1: WHEN 用户指定包含 AT2 文件的目录 THE SYSTEM SHALL 批量解析所有 .AT2 文件，提取时间步长 dt、加速度时程数据和文件头信息
- [ ] AC-2.2: WHEN 用户导入 txt 格式地震动文件（单列/双列）THE SYSTEM SHALL 正确解析并加载数据
- [ ] AC-2.3: WHEN 文件格式不正确或数据异常 THE SYSTEM SHALL 给出明确的错误提示，跳过该文件继续处理其余文件
- [ ] AC-2.4: WHEN 文件加载完成 THE SYSTEM SHALL 显示已加载地震动的列表（文件名、dt、持时、PGA）

### US-3: 地震动选波

作为结构工程师，我希望根据 GB 50011 规范要求自动从地震动数据库中筛选满足条件的天然地震波，以便用于时程分析。

**验收标准**：
- [ ] AC-3.1: WHEN 用户指定结构前三阶自振周期（T₁, T₂, T₃）THE SYSTEM SHALL 按以下三步筛选地震波：
  - 步骤一：有效持时筛选（有效持时 ≥ 5T₁，有效持时定义为加速度首次达到 PGA×10% 到最后一次达到 PGA×10% 的时间段）
  - 步骤二：主周期点反应谱偏差校核（在 T₁、T₂、T₃ 处，归一化反应谱值与规范谱偏差 ≤ 20%）
  - 步骤三（可选）：底部剪力校核（时程分析底部剪力与振型分解反应谱法 SRSS 结果之比在 0.65~1.35 之间）
- [ ] AC-3.2: WHEN 筛选完成 THE SYSTEM SHALL 显示满足条件的地震波列表，包含各周期点偏差值和有效持时
- [ ] AC-3.3: WHEN 用户选择某条地震波 THE SYSTEM SHALL 显示其加速度时程曲线和反应谱曲线（与规范谱叠加对比）
- [ ] AC-3.4: WHEN 用户确认选波结果 THE SYSTEM SHALL 将选中的地震波文件复制到指定输出目录，并生成选波报告（含统计表格和反应谱对比图）

### US-4: 反应谱计算

作为结构工程师，我希望计算任意地震动的加速度、速度和位移反应谱，以便评估地震动特性。

**验收标准**：
- [ ] AC-4.1: WHEN 用户加载地震动数据并指定阻尼比 THE SYSTEM SHALL 使用 Newmark-β 法计算加速度反应谱（Sa）、速度反应谱（Sv）和位移反应谱（Sd）
- [ ] AC-4.2: WHEN 用户选择不同计算方法 THE SYSTEM SHALL 支持 Newmark-β 法、频域法和混合法三种反应谱计算方法
- [ ] AC-4.3: WHEN 用户指定多条地震波 THE SYSTEM SHALL 计算并显示各条波的反应谱及其平均谱
- [ ] AC-4.4: WHEN 反应谱计算完成 THE SYSTEM SHALL 支持与规范谱叠加显示，并导出数据

### US-5: 人工地震波生成

作为结构工程师，我希望基于目标反应谱生成人工地震波，以便补充天然波不足时使用。

**验收标准**：
- [ ] AC-5.1: WHEN 用户指定目标反应谱（规范谱或自定义谱）THE SYSTEM SHALL 通过迭代谱拟合算法生成人工地震波，使生成波的反应谱与目标谱的最大偏差 ≤ 5%
- [ ] AC-5.2: WHEN 用户指定 PGA 峰值 THE SYSTEM SHALL 将生成的人工波缩放至指定峰值
- [ ] AC-5.3: WHEN 人工波生成完成 THE SYSTEM SHALL 显示生成波的时程曲线和反应谱与目标谱的对比图
- [ ] AC-5.4: WHEN 用户确认 THE SYSTEM SHALL 支持导出人工波为 txt/AT2 格式

### US-6: 地震动信号处理

作为结构工程师，我希望对地震动记录进行基线校正、滤波等预处理，以便获得高质量的输入数据。

**验收标准**：
- [ ] AC-6.1: WHEN 用户选择基线校正 THE SYSTEM SHALL 支持多项式去趋势（1~6阶）和双线性去趋势两种方法
- [ ] AC-6.2: WHEN 用户选择滤波 THE SYSTEM SHALL 支持 Butterworth 带通/低通/高通滤波，可指定阶数和截止频率
- [ ] AC-6.3: WHEN 用户执行积分 THE SYSTEM SHALL 从加速度时程计算速度和位移时程（支持原始积分和有理积分）
- [ ] AC-6.4: WHEN 用户选择裁剪 THE SYSTEM SHALL 支持手动和自动（基于 Arias 强度）裁剪地震动记录

### US-7: 频谱分析

作为结构工程师，我希望查看地震动的频域特性，以便了解其频率成分。

**验收标准**：
- [ ] AC-7.1: WHEN 用户选择频谱分析 THE SYSTEM SHALL 计算并显示傅里叶振幅谱（FAS）
- [ ] AC-7.2: WHEN 用户选择功率谱分析 THE SYSTEM SHALL 使用 Welch 方法计算功率谱密度（PSD）

### US-8: Windows 桌面应用

作为用户，我希望在 Windows 上通过图形界面使用所有功能，无需编程知识。

**验收标准**：
- [ ] AC-8.1: WHEN 用户启动应用程序 THE SYSTEM SHALL 显示现代学术科研风格的主界面，采用深色/浅色主题切换、清晰的数据可视化配色、专业的排版布局
- [ ] AC-8.2: WHEN 用户通过界面操作 THE SYSTEM SHALL 提供完整的 GUI 工作流：参数设置 → 数据导入 → 计算/选波 → 结果查看 → 导出
- [ ] AC-8.3: WHEN 用户在 Windows 10/11 上运行 THE SYSTEM SHALL 无需安装 Python 环境即可运行（打包为独立 exe 或安装包）
- [ ] AC-8.4: WHEN 计算耗时较长 THE SYSTEM SHALL 显示进度条，且界面不卡顿（计算在后台线程执行）

### US-9: 数据导出与报告

作为结构工程师，我希望导出计算结果和选波报告，以便用于论文和工程报告。

**验收标准**：
- [ ] AC-9.1: WHEN 用户选择导出 THE SYSTEM SHALL 支持将时程数据导出为 txt/csv/AT2 格式
- [ ] AC-9.2: WHEN 用户选择导出反应谱 THE SYSTEM SHALL 支持导出为 CSV 数据和 PNG/SVG 图片
- [ ] AC-9.3: WHEN 选波完成 THE SYSTEM SHALL 生成选波报告，包含：选波参数、筛选统计、各波偏差表格、反应谱对比图

## 约束条件

- Python 3.10+，核心依赖：NumPy、SciPy、Matplotlib
- GUI 框架需支持 Windows 打包（PyQt6 或 PySide6）
- 打包工具：PyInstaller 或 Nuitka
- 反应谱计算性能：100 条波 × 600 个周期点应在 30 秒内完成（可用 NumPy 向量化或 Numba JIT 加速）
- 兼容 PEER NGA-West2 的 AT2 文件格式（包括新旧两种头部格式）
- 规范谱参数需与 GB 50011-2010（2016年版）一致
- v2 仅实现 GB 50011 规范谱，预留扩展接口供后续添加其他规范

## 超出范围

- 在线从 PEER 数据库下载地震动（需用户自行下载）
- 非线性反应谱计算（v2 暂不实现，预留接口）
- 多点激励 / 空间相关性分析
- 结构有限元分析（底部剪力校核需用户提供质量和刚度矩阵）
- macOS / Linux 原生 GUI（但 Python 核心库跨平台可用）
